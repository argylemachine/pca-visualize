<!DOCTYPE html>
<html>
    <head>
        <title>Principle Components Analysis Visualize</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/bootstrap/dist/css/bootstrap.css" rel="stylesheet" media="screen">
	<link href="/lib/jumbotron.css" rel="stylesheet">
	<link href="lib/jquery-ui.min.css" rel="stylesheet">
	<style type="text/css" rel="stylesheet">
	#graph {
		width: 100%;
		background-color: red;
		height: 550px;
	}
	.jumbotron {
		background-color: #ffffff;
	}
	</style>
    </head>
    <body>
	<div class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
          			</button>
          			<a class="navbar-brand" href="#">PCA Visualize</a>
        		</div>
        		<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="#">Home</a></li>
					<li><a href="#about">About</a></li>

					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown">Filters <b class="caret"></b></a>
						<ul class="dropdown-menu">
							<li class="dropdown-header">Filters</li>
							<li><a href="#">Change Selection Filters</a></li>
							<li><a href="#">Change Display Filters</a></li>
						</ul>
					</li>
					
				    	<li class="dropdown">
		      				<a href="#" class="dropdown-toggle" data-toggle="dropdown">Attributes <b class="caret"></b></a>
              					<ul class="dropdown-menu">
							<li class="dropdown-header">Attributes</li>
                					<li><a href="#">Modify Attributes</a></li>
							<li><a href="#">Modify Custom Attributes</a></li>
							<li><a href="#">Weight Attributes</a></li>
              					</ul>
            				</li>

					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
						<ul class="dropdown-menu">
							<li class="dropdown-header">Documentation</li>
							<li><a href="#">Custom Attributes</a></li>
							<li><a href="#">Weighting Attributes</a></li>
							<li><a href="#">Selection Filters</a></li>
							<li><a href="#">Display Filters</a></li>
						</ul>
					</li>
          			</ul>
				<div class="navbar-right navbar-form">
					<div class="btn btn-danger" id="reset_session">Reset Session</div>
				</div>
			</div>
      		</div>
    	</div>

	<div class="jumbotron">
		<div id="graph"></div>
	</div>

	<div id="working">
		<div class="message">We're working.. hang tight.</div>
		<div class="progressbar"></div>
	</div>

        <script src="/lib/jquery.min.js"></script>
	<script src="/lib/jquery-ui.min.js"></script>
	<script src="/lib/async.js"></script>
	<script src="/lib/canvasjs.min.js"></script>
        <script src="/bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript">
	$(document).ready( function( ){

		show_working_modal = function( cb ){
			$("#working").dialog( { modal: true,
						title: "Working..",
						draggable: false,
						resizable: false,
						minWidth: 400,
						minHeight: 200 } );
			$("#working .progressbar").progressbar( { value: false } );
			return cb( null );
		}

		hide_working_modal = function( cb ){
			// Destroy the progressbar ui.. 
			$("#working .progressbar").progressbar( "destroy" );

			// Close the working modal.
			$("#working").dialog( "close" );

			return cb( null );
		}

		login = function( username, password, cb ){
			// Try and login with the username and password specified.
			$.getJSON( "/login", { "username": username, "password": password }, function( result ){
				if( result == true ){
					return cb( null );
				}else{
					return cb( result );
				}
			} );

			// TOOD - note that we don't catch HTTP request fail.. 
		}

		update_graph = function( cb ){
			// Setup a data object that conforms to canvasjs specs.
			// Then set it into the graph object, and call .render.

			// Note that this does not do any filtering.. any data that is
			// currently in data_points will be shown.

			_data = { 	type: "scatter",
					markerSize: 15,
					dataPoints: data_points }

			graph.options.data = _data;
			graph.render( );

			return cb( null );
		}

		get_attributes = function( cb ){
			// Make a request for what attributes are available.
			// Update the HTML side of things with any additions / removals.
			$.getJSON( "/api/attributes", function( attributes ){

				// Iterate over each attribute..
				async.eachSeries( attributes, function( attribute, cb ){
					// Check if the attribute exists in the HTML dom.
					// if it does simply call cb..
					// If not, add it to the dom and then call cb.
					return cb( null );
				}, cb );
			} );
		}

		// Make the call to reset the session..
		$("#reset_session").click( function( event ){
			async.series( [ show_working_modal, function( cb ){
				// Make the http call to kill the session.
				$.getJSON( "/logout", function( response ){
					if( response == true ){

						// Login as guest again..
						login( "guest", "guest", cb );

					}else{
						cb( response );
					}
				} );

			}, hide_working_modal ], function( err, cb ){
				
			} );
		} );
	
		// Initial setup of the canvasjs graph.	
		graph = new CanvasJS.Chart( "graph", {	"title": { "text": "What?" },
							"data": { },
							"toolTip": {
								"content": function( e ){
									return "Some information about the point..";
								}
							},
							"axisY": { "gridThickness": -1, "labelFontSize": -1 },
							"axisX": { "gridThickness": -1, "labelFontSize": -1 }
						} );

		graph.render( );

		// Inital login and query for particulars.
		async.series( [ show_working_modal, function( cb ){
				login( "guest", "guest", cb );
		}, get_attributes, hide_working_modal ], function( err, res ){
			if( err ){
				return console.log( "Startup error: " + err );
			}
			console.log( "Finished startup!" );
		} );

	} );
	</script>
    </body>
</html>
