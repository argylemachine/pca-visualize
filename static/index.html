<html>
	<head>
		<title>PCA Visualize</title>
		<script src="lib/jquery.min.js"></script>
		<script src="lib/jquery-ui.min.js"></script>
		<script src="lib/canvasjs.min.js"></script>
		<script src="lib/async.js"></script>
		<link rel="stylesheet" type="text/css" href="lib/jquery-ui.min.css" />
		<link rel="stylesheet" type="text/css" href="lib/style.css" />
		<script type="text/javascript">
		$(document).ready( function( ){

			// Hide things that should be hidden by default.
			$(".hide").hide( );
			
			// The about dialog box.
			$("#about").dialog( {	title: true,
						draggable: false,
						resizable: false,
						minWidth: 400,
						minHeight: 200,
						autoOpen: false } );

			// Show the loading modal.
			show_loading = function( cb ){
				$("#loading").dialog( { modal: true,
							title: "Loading.",
							draggable: false,
							resizable: false,
							minWidth: 400,
							minHeight: 200 } );
				$("#loading_progressbar").progressbar( { value: false } );
				return cb( null );
			}

			// Destroy the loading modal.
			hide_loading = function( cb ){
				$("#loading_progressbar").progressbar( "destroy" );
				$("#loading").dialog( "close" );
				return cb( null );
			}

			// This function updates the attribute checkbox list.
			update_attributes = function( cb ){
				// Clear any existing content in the attributes element.
				$("#attributes").html( "" );

				// Make a query for what attributes are available.
				$.getJSON( "/attributes", function( res ){
					
					// If we get an error back, cb it out.
					if( "error" in Object.keys( res ) ){
						return cb( res.error );
					}

					// Iterate over the response we got and generate
					// the new HTML for the attributes element.
					new_html = "<table>";
					for( var i in res ){
						var attr = res[i];
						new_html += "<tr><td><input checked='checked' type='checkbox' name='" + attr + "'></td><td>" + attr + "</td></tr>";
						
					}
					new_html += "</table>";

					// Set the new content. This is required so that we can then use a 
					// jquery selector and handle when checkboxes are changed.
					$("#attributes").html( new_html );
			
					// Iterate over each of the checkboxes we just defined in the new html.
					$("#attributes :checkbox").each( function( i, chkbx ){

						// Setup a callback hook when they change.
						$(chkbx).change( function( e ){
							update_graph( function( ){ } );
						} );
					} );
				} );
			}

			// Handle the entire process of updating the graph.
			// This includes the logic around showing the modal
			// as well as closing it.
			update_graph = function( cb ){
				async.series( [ show_loading,
						update_documents,
						hide_loading ],
				function( err, res ){
					return cb( null );
				} );
			}

			// Make the request for documents.
			// Note that this uses get_filters, get_attributes, and get_includes
			update_documents = function( cb ){
				async.series( [ get_filters, get_attributes, get_includes ], function( err, res ){
					if( err ){ return cb( err ); };

					$.getJSON( "/pca", { "filter": res[0], "attributes": res[1], "includes": res[2] }, function( res ){
						
					} );
				} );
				return cb( null );
			}

			main_graph	= { }
			songs		= { }
			// Enumerate the available options here.. somewhat modularized for other systems in the future.
			options = [ "duration", "tempo", "liveness", "speechiness", "acousticness", "mode", "key", "energy", "time_signature", "loudness", "valence",  "danceability" ];

			setup_canvas = function( cb ){
				main_graph = new CanvasJS.Chart( "main_graph", {	"title": { "text": "Library Visualization" },
											"data": { },
											"toolTip": {
												"content": function( e ){
													// Rather than referencing this all the time..
													_dp = e.entries[0].dataPoint;

													// Define the return string that we'll concat to.
													_return = "Title: <b>" + _dp["title"] + "</b><br />Artist: <b>" + _dp["artist"] + "</b><br />";

													_selected_options = selected_options( );
													// Iterate over the tooltip_options..
													for( var i in _selected_options ){
														tool_tip = _selected_options[i];
														_return += tool_tip + ": " + _dp[tool_tip] + "<br />";
													}
													return _return;
												}
											},
											"axisY": { "gridThickness": -1, "labelFontSize": -1 },
											"axisX": { "gridThickness": -1, "labelFontSize": -1 } } );
				main_graph.render( );
				return cb( null );
			}
			
			setup_options = function( cb ){

				// Iterate through all the options and fill in the div..
				$("#options").append( "<table id='options_table'>" );
				for( var i=0; i<options.length; i++ ){
					option = options[i];
					$("#options_table").append( "<tr><td><input checked='checked' type='checkbox' name='" + option +"'></td><td>" + option + "</td></tr>" );
				}
				$("#options").append("</table>");

				$("#options_table :checkbox").each( function( i, chkbox ){
					$(chkbox).change( function( e ){
						async.series( [ show_loading, clear_songs, load_songs, update_graph, hide_loading ], function( err, res ){
							
						} );
					} );
				} );

				return cb( null );
			}

			selected_options = function( ){
				// This function returns a list of selected options.
				_r = [ ];
				boxes = $("#options_table :checkbox");
				for( var i=0; i<boxes.length; i++ ){
					box = $(boxes[i]);
					if( box.prop("checked") ){
						_r.push( box.attr( "name" ) );
					}
				}
				return _r;
			}

			clear_songs = function( cb ){
				// Just a handy function that clears the songs we know about.
				songs = { }
				return cb( null );
			}

			load_songs = function( cb ){
				// This function queries for the basic information.. it uses
				// selected_options and sets the value of the global songs object.

				_data		= { }
				_data['pca']	= selected_options( );
				$.ajax( "/pca/basic", { "data": _data,
							"complete": function( res ){
								songs = res.responseJSON;
								return cb( null );
							},
							"error": function( err ){
								return cb( err );
							} } );
			}

			update_graph = function( cb ){
				// This function updates the main graph with the contents of songs.

				// Split songs up by artist..
				data_by_artists = { };
				for( var i in songs ){
					var song		= songs[i];
					if( Object.keys( data_by_artists ).indexOf( song.artist ) < 0 ){
						data_by_artists[song.artist] = [ ];
					}
					
					data_by_artists[song.artist].push( song );
				}

				_data = [ ];
				for( var artist in data_by_artists ){
					_data.push( {	type: "scatter",
						markerSize: 15,
						dataPoints: data_by_artists[artist],
						click: function( e ){
							$("#player").html( "Would play /song/" + e.dataPoint._id );
						} } );
				}

				main_graph.options.data = _data
				main_graph.render( );
				return cb( null );
			}

			async.series( [ show_loading, setup_canvas, setup_options, load_songs, update_graph, hide_loading ], function( err, res ){
				
			} );
			
		} );
		</script>
	</head>
	<body>
		<div id="top">
			Some top stuff.
		</div>
		<div id="about" class="hide">
			<p>This is <a href='https://github.com/argylemachine/music-player'>music-player</a>. It is released open source under the <a href='https://raw.github.com/argylemachine/music-player/develop/LICENSE'>MIT</a> license.</p>
			<p>Original idea and inspiration came from <a href='http://thesis.flyingpudding.com/'>Music Box</a> by <a href='http://flyingpudding.com/'>Anita Shen Lillie</a>.</p>
		</div>
		<div id="right">
			<div id="options"><h3>Attributes</h3></div>
			<div id="menu">
				<h3>Links</h3>
				<ul>
					<li><a href='#' onclick="$('#about').dialog('open');">About</a></li>
					<li><a href='https://github.com/argylemachine/music-player'>Source Code</a></li>
				</ul>
			</div>
		</div>
		<div id="main_graph"></div>
		<div id="loading">
			<div class="message">The hamsters are running. Hold on!</div>
			<p><div id="progressbar"></div></p>
			<div class="detail_message"></div>
		</div>
	</body>
</html>
